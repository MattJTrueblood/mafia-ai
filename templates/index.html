<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia AI - Setup</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        .preset-buttons button {
            padding: 8px 16px;
            font-size: 14px;
        }
        .preset-buttons button.active {
            background-color: #4a9eff;
            border-color: #4a9eff;
        }
        .role-config {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .role-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .role-input label {
            min-width: 70px;
        }
        .role-input input[type="number"] {
            width: 60px;
            padding: 6px;
            text-align: center;
        }
        .model-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
        }
        .model-actions select {
            flex: 1;
            max-width: 400px;
        }
        .player-count-display {
            margin-bottom: 10px;
            font-size: 14px;
            color: #888;
        }
        .human-player-config {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .human-player-config label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .human-player-config input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .human-options {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .human-options.visible {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .human-option {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .human-option label {
            font-size: 13px;
            color: #aaa;
        }
        .human-option select {
            min-width: 150px;
        }
        /* Advanced Rules Styles */
        .advanced-rules {
            margin-bottom: 20px;
        }
        .advanced-rules-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            user-select: none;
        }
        .advanced-rules-header:hover {
            background: rgba(255,255,255,0.08);
        }
        .advanced-rules-content {
            display: none;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 0 0 8px 8px;
            margin-top: 2px;
        }
        .advanced-rules-content.visible {
            display: block;
        }
        .rule-group {
            margin-bottom: 16px;
        }
        .rule-group h4 {
            margin-bottom: 8px;
            color: #aaa;
            font-size: 14px;
        }
        .rule-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            padding: 8px 0;
        }
        .rule-item label {
            flex: 1;
            font-size: 14px;
        }
        .rule-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .rule-item input[type="number"] {
            width: 60px;
            padding: 6px;
            text-align: center;
        }
        .chevron {
            transition: transform 0.2s;
        }
        .chevron.expanded {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mafia AI Game Setup</h1>

        <h3>Presets</h3>
        <div class="preset-buttons">
            <button type="button" data-preset="micro">Micro (5)</button>
            <button type="button" data-preset="classic">Classic (7)</button>
            <button type="button" data-preset="standard" class="active">Standard (9)</button>
            <button type="button" data-preset="competitive">Competitive (10)</button>
            <button type="button" data-preset="large">Large (12)</button>
            <button type="button" data-preset="violent">Violent (9)</button>
            <button type="button" data-preset="mountainous">Mountainous (11)</button>
            <button type="button" data-preset="micro_jester">Micro Jester (6)</button>
            <button type="button" data-preset="classic_jester">Classic Jester (10)</button>
            <button type="button" data-preset="powderkeg">Powderkeg (9)</button>
            <button type="button" data-preset="carnival">Carnival (10)</button>
            <button type="button" data-preset="deception">Deception (9)</button>
            <button type="button" data-preset="fog_of_war">Fog of War (7)</button>
            <button type="button" data-preset="hall_of_mirrors">Hall of Mirrors (10)</button>
        </div>

        <h3>Role Configuration</h3>
        <div class="role-config">
            <div class="role-input">
                <label>Mafia:</label>
                <input type="number" id="role-mafia" min="0" max="10" value="2">
            </div>
            <div class="role-input">
                <label>Godfather:</label>
                <input type="number" id="role-godfather" min="0" max="3" value="0">
            </div>
            <div class="role-input">
                <label>Villager:</label>
                <input type="number" id="role-villager" min="0" max="20" value="4">
            </div>
            <div class="role-input">
                <label>Miller:</label>
                <input type="number" id="role-miller" min="0" max="3" value="0">
            </div>
            <div class="role-input">
                <label>Sheriff:</label>
                <input type="number" id="role-sheriff" min="0" max="3" value="1">
            </div>
            <div class="role-input">
                <label>Doctor:</label>
                <input type="number" id="role-doctor" min="0" max="3" value="1">
            </div>
            <div class="role-input">
                <label>Vigilante:</label>
                <input type="number" id="role-vigilante" min="0" max="3" value="1">
            </div>
            <div class="role-input">
                <label>Jester:</label>
                <input type="number" id="role-jester" min="0" max="3" value="0">
            </div>
        </div>

        <h3>Human Player (Optional)</h3>
        <div class="human-player-config">
            <label>
                <input type="checkbox" id="enable-human">
                Play as a human player
            </label>
            <div id="human-options" class="human-options">
                <div class="human-option">
                    <label>Play as:</label>
                    <select id="human-player-select">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="human-option">
                    <label>Force role:</label>
                    <select id="human-role-select">
                        <option value="">Random</option>
                        <!-- Populated by JS based on role distribution -->
                    </select>
                </div>
            </div>
        </div>

        <h3>Advanced Rules</h3>
        <div class="advanced-rules">
            <div class="advanced-rules-header" id="rules-toggle">
                <span class="chevron" id="rules-chevron">&#9658;</span>
                <span>Customize game rules (click to expand)</span>
            </div>
            <div id="rules-content" class="advanced-rules-content">
                <div class="rule-group">
                    <h4>Day 1 Rules</h4>
                    <div class="rule-item">
                        <label>Day 1 round-robin only (no interrupts)</label>
                        <input type="checkbox" id="rule-day1-round-robin" checked>
                    </div>
                    <div class="rule-item">
                        <label>Day 1 no lynch</label>
                        <input type="checkbox" id="rule-day1-no-lynch" checked>
                    </div>
                </div>

                <div class="rule-group">
                    <h4>Doctor Rules</h4>
                    <div class="rule-item">
                        <label>Can protect same player twice in a row</label>
                        <input type="checkbox" id="rule-doctor-same-twice">
                    </div>
                    <div class="rule-item">
                        <label>Can self-protect</label>
                        <input type="checkbox" id="rule-doctor-self-protect" checked>
                    </div>
                </div>

                <div class="rule-group">
                    <h4>Vigilante Rules</h4>
                    <div class="rule-item">
                        <label>Can abstain (choose not to shoot)</label>
                        <input type="checkbox" id="rule-vigilante-abstain" checked>
                    </div>
                    <div class="rule-item">
                        <label>Number of bullets</label>
                        <input type="number" id="rule-vigilante-bullets" min="1" max="5" value="1">
                    </div>
                </div>

                <div class="rule-group">
                    <h4>Godfather Rules</h4>
                    <div class="rule-item">
                        <label>Immunity requires other mafia alive</label>
                        <input type="checkbox" id="rule-godfather-requires-mafia">
                    </div>
                    <div class="rule-item">
                        <label>Single-use immunity (consumed after first investigation)</label>
                        <input type="checkbox" id="rule-godfather-single-use">
                    </div>
                </div>

                <div class="rule-group">
                    <h4>Miller Rules</h4>
                    <div class="rule-item">
                        <label>Single-use false positive (second investigation shows true alignment)</label>
                        <input type="checkbox" id="rule-miller-single-use">
                    </div>
                </div>

                <div class="rule-group">
                    <h4>Voting Rules</h4>
                    <div class="rule-item">
                        <label>Require majority to lynch</label>
                        <input type="checkbox" id="rule-require-majority" checked>
                    </div>
                    <div class="rule-item">
                        <label>Allow no-lynch (ties = nobody dies)</label>
                        <input type="checkbox" id="rule-allow-no-lynch" checked>
                    </div>
                </div>

                <div class="rule-group">
                    <h4>Discussion Rules</h4>
                    <div class="rule-item">
                        <label>Max discussion messages before vote</label>
                        <input type="number" id="rule-max-discussion" min="5" max="30" value="10">
                    </div>
                </div>
            </div>
        </div>

        <h3>Model Assignment</h3>
        <div class="model-actions">
            <select id="bulk-model-select">
                <!-- Populated by JS -->
            </select>
            <button type="button" id="set-all-models-btn">Set All</button>
            <button type="button" id="random-models-btn">Randomize</button>
        </div>

        <form id="setup-form">
            <div class="player-count-display">
                <span id="player-count-text">9 players</span>
            </div>
            <div id="players-container">
                <!-- Players will be added here -->
            </div>

            <div style="margin-top: 20px;">
                <button type="submit" id="start-game-btn">Start Game</button>
            </div>
        </form>

        <div id="error-message" class="error" style="display: none;"></div>
    </div>

    <script>
        const defaultModels = {{ default_models | tojson }};
        const modelPricing = {{ model_pricing | tojson }};
        const defaultNames = [
            'Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Heidi',
            'Ivan', 'Judy', 'Kevin', 'Luna', 'Mike', 'Nina', 'Oscar', 'Pam'
        ];

        const PRESETS = {
            micro:         { Mafia: 1, Godfather: 0, Sheriff: 1, Doctor: 0, Vigilante: 0, Jester: 0, Miller: 0, Villager: 3 },
            classic:       { Mafia: 2, Godfather: 0, Sheriff: 1, Doctor: 1, Vigilante: 0, Jester: 0, Miller: 0, Villager: 3 },
            standard:      { Mafia: 2, Godfather: 0, Sheriff: 1, Doctor: 1, Vigilante: 1, Jester: 0, Miller: 0, Villager: 4 },
            competitive:   { Mafia: 3, Godfather: 0, Sheriff: 1, Doctor: 1, Vigilante: 1, Jester: 0, Miller: 0, Villager: 4 },
            large:         { Mafia: 3, Godfather: 0, Sheriff: 1, Doctor: 1, Vigilante: 1, Jester: 0, Miller: 0, Villager: 6 },
            violent:       { Mafia: 2, Godfather: 0, Sheriff: 1, Doctor: 0, Vigilante: 2, Jester: 0, Miller: 0, Villager: 4 },
            mountainous:   { Mafia: 2, Godfather: 0, Sheriff: 0, Doctor: 0, Vigilante: 0, Jester: 0, Miller: 0, Villager: 9 },
            micro_jester:  { Mafia: 1, Godfather: 0, Sheriff: 1, Doctor: 0, Vigilante: 0, Jester: 1, Miller: 0, Villager: 3 },
            classic_jester:{ Mafia: 2, Godfather: 0, Sheriff: 1, Doctor: 1, Vigilante: 1, Jester: 1, Miller: 0, Villager: 4 },
            powderkeg:     { Mafia: 2, Godfather: 0, Sheriff: 1, Doctor: 0, Vigilante: 2, Jester: 1, Miller: 0, Villager: 3 },
            carnival:      { Mafia: 2, Godfather: 0, Sheriff: 0, Doctor: 0, Vigilante: 0, Jester: 2, Miller: 0, Villager: 6 },
            deception:     { Mafia: 1, Godfather: 1, Sheriff: 1, Doctor: 1, Vigilante: 0, Jester: 0, Miller: 1, Villager: 4 },
            fog_of_war:    { Mafia: 0, Godfather: 1, Sheriff: 1, Doctor: 1, Vigilante: 0, Jester: 0, Miller: 1, Villager: 3 },
            hall_of_mirrors:{ Mafia: 1, Godfather: 1, Sheriff: 2, Doctor: 1, Vigilante: 0, Jester: 0, Miller: 2, Villager: 3 }
        };

        function formatPricing(modelId) {
            if (modelPricing[modelId]) {
                const p = modelPricing[modelId];
                return ` ($${p.input.toFixed(2)}/$${p.output.toFixed(2)})`;
            }
            return '';
        }

        function getTotalPlayers() {
            return parseInt(document.getElementById('role-mafia').value || 0)
                 + parseInt(document.getElementById('role-godfather').value || 0)
                 + parseInt(document.getElementById('role-villager').value || 0)
                 + parseInt(document.getElementById('role-miller').value || 0)
                 + parseInt(document.getElementById('role-sheriff').value || 0)
                 + parseInt(document.getElementById('role-doctor').value || 0)
                 + parseInt(document.getElementById('role-vigilante').value || 0)
                 + parseInt(document.getElementById('role-jester').value || 0);
        }

        function getRoleDistribution() {
            return {
                Mafia: parseInt(document.getElementById('role-mafia').value || 0),
                Godfather: parseInt(document.getElementById('role-godfather').value || 0),
                Villager: parseInt(document.getElementById('role-villager').value || 0),
                Miller: parseInt(document.getElementById('role-miller').value || 0),
                Sheriff: parseInt(document.getElementById('role-sheriff').value || 0),
                Doctor: parseInt(document.getElementById('role-doctor').value || 0),
                Vigilante: parseInt(document.getElementById('role-vigilante').value || 0),
                Jester: parseInt(document.getElementById('role-jester').value || 0)
            };
        }

        function getGameRules() {
            return {
                day1_round_robin_only: document.getElementById('rule-day1-round-robin').checked,
                day1_no_lynch: document.getElementById('rule-day1-no-lynch').checked,
                doctor_can_protect_same_twice: document.getElementById('rule-doctor-same-twice').checked,
                doctor_can_self_protect: document.getElementById('rule-doctor-self-protect').checked,
                vigilante_can_abstain: document.getElementById('rule-vigilante-abstain').checked,
                vigilante_bullets: parseInt(document.getElementById('rule-vigilante-bullets').value) || 1,
                godfather_requires_other_mafia: document.getElementById('rule-godfather-requires-mafia').checked,
                godfather_single_use_immunity: document.getElementById('rule-godfather-single-use').checked,
                miller_single_use_false_positive: document.getElementById('rule-miller-single-use').checked,
                require_majority_to_lynch: document.getElementById('rule-require-majority').checked,
                allow_no_lynch: document.getElementById('rule-allow-no-lynch').checked,
                max_discussion_messages: parseInt(document.getElementById('rule-max-discussion').value) || 10
            };
        }

        function applyPreset(presetName) {
            const preset = PRESETS[presetName];
            if (!preset) return;

            document.getElementById('role-mafia').value = preset.Mafia;
            document.getElementById('role-godfather').value = preset.Godfather || 0;
            document.getElementById('role-villager').value = preset.Villager;
            document.getElementById('role-miller').value = preset.Miller || 0;
            document.getElementById('role-sheriff').value = preset.Sheriff;
            document.getElementById('role-doctor').value = preset.Doctor;
            document.getElementById('role-vigilante').value = preset.Vigilante;
            document.getElementById('role-jester').value = preset.Jester || 0;

            // Update active button
            document.querySelectorAll('.preset-buttons button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.preset === presetName);
            });

            rebuildPlayers();
        }

        function rebuildPlayers() {
            const container = document.getElementById('players-container');
            const total = getTotalPlayers();

            // Preserve existing names and models where possible
            const existingData = [];
            container.querySelectorAll('.player-row').forEach((row, i) => {
                const nameInput = row.querySelector('input[type="text"]');
                const modelSelect = row.querySelector('select');
                existingData.push({
                    name: nameInput?.value || '',
                    model: modelSelect?.value || ''
                });
            });

            container.innerHTML = '';

            for (let i = 0; i < total; i++) {
                const existing = existingData[i];
                const defaultName = existing?.name || defaultNames[i] || `Player ${i + 1}`;
                const defaultModel = existing?.model || defaultModels[Math.floor(Math.random() * defaultModels.length)];
                addPlayerRow(i + 1, defaultName, defaultModel);
            }

            document.getElementById('player-count-text').textContent = `${total} players`;
            updateHumanPlayerOptions();
        }

        function updateHumanPlayerOptions() {
            const playerSelect = document.getElementById('human-player-select');
            const roleSelect = document.getElementById('human-role-select');

            // Update player dropdown with current player names
            const playerNames = [];
            document.querySelectorAll('#players-container input[type="text"]').forEach(input => {
                if (input.value) {
                    playerNames.push(input.value);
                }
            });

            const currentPlayer = playerSelect.value;
            playerSelect.innerHTML = playerNames.map(name => {
                const selected = name === currentPlayer ? ' selected' : '';
                return `<option value="${name}"${selected}>${name}</option>`;
            }).join('');

            // Update role dropdown based on role distribution
            const roles = getRoleDistribution();
            const currentRole = roleSelect.value;
            let roleOptions = '<option value="">Random</option>';

            if (roles.Mafia > 0) roleOptions += `<option value="Mafia"${currentRole === 'Mafia' ? ' selected' : ''}>Mafia</option>`;
            if (roles.Godfather > 0) roleOptions += `<option value="Godfather"${currentRole === 'Godfather' ? ' selected' : ''}>Godfather</option>`;
            if (roles.Villager > 0) roleOptions += `<option value="Villager"${currentRole === 'Villager' ? ' selected' : ''}>Villager</option>`;
            if (roles.Miller > 0) roleOptions += `<option value="Miller"${currentRole === 'Miller' ? ' selected' : ''}>Miller</option>`;
            if (roles.Sheriff > 0) roleOptions += `<option value="Sheriff"${currentRole === 'Sheriff' ? ' selected' : ''}>Sheriff</option>`;
            if (roles.Doctor > 0) roleOptions += `<option value="Doctor"${currentRole === 'Doctor' ? ' selected' : ''}>Doctor</option>`;
            if (roles.Vigilante > 0) roleOptions += `<option value="Vigilante"${currentRole === 'Vigilante' ? ' selected' : ''}>Vigilante</option>`;
            if (roles.Jester > 0) roleOptions += `<option value="Jester"${currentRole === 'Jester' ? ' selected' : ''}>Jester</option>`;

            roleSelect.innerHTML = roleOptions;
        }

        function addPlayerRow(num, name, selectedModel) {
            const container = document.getElementById('players-container');
            const div = document.createElement('div');
            div.className = 'player-row';

            div.innerHTML = `
                <label>Player ${num}:</label>
                <input type="text" name="player${num}_name" value="${name}" required>
                <select name="player${num}_model" required>
                    ${defaultModels.map(model => {
                        const pricing = formatPricing(model);
                        const selected = model === selectedModel ? ' selected' : '';
                        return `<option value="${model}"${selected}>${model}${pricing}</option>`;
                    }).join('')}
                </select>
            `;
            container.appendChild(div);
        }

        function setAllModels(model) {
            document.querySelectorAll('#players-container select').forEach(select => {
                select.value = model;
            });
        }

        function randomizeModels() {
            document.querySelectorAll('#players-container select').forEach(select => {
                const randomModel = defaultModels[Math.floor(Math.random() * defaultModels.length)];
                select.value = randomModel;
            });
        }

        function initializeBulkModelSelect() {
            const select = document.getElementById('bulk-model-select');
            select.innerHTML = defaultModels.map(model => {
                const pricing = formatPricing(model);
                return `<option value="${model}">${model}${pricing}</option>`;
            }).join('');
        }

        // Preset button handlers
        document.querySelectorAll('.preset-buttons button').forEach(btn => {
            btn.addEventListener('click', () => applyPreset(btn.dataset.preset));
        });

        // Role input change handlers
        document.querySelectorAll('.role-config input').forEach(input => {
            input.addEventListener('change', () => {
                // Clear active preset when manually editing
                document.querySelectorAll('.preset-buttons button').forEach(btn => {
                    btn.classList.remove('active');
                });
                rebuildPlayers();
            });
        });

        // Set all models button
        document.getElementById('set-all-models-btn').addEventListener('click', () => {
            const model = document.getElementById('bulk-model-select').value;
            setAllModels(model);
        });

        // Random models button
        document.getElementById('random-models-btn').addEventListener('click', randomizeModels);

        // Human player toggle
        document.getElementById('enable-human').addEventListener('change', (e) => {
            const humanOptions = document.getElementById('human-options');
            if (e.target.checked) {
                humanOptions.classList.add('visible');
                updateHumanPlayerOptions();
            } else {
                humanOptions.classList.remove('visible');
            }
        });

        // Advanced rules toggle
        document.getElementById('rules-toggle').addEventListener('click', () => {
            const content = document.getElementById('rules-content');
            const chevron = document.getElementById('rules-chevron');
            content.classList.toggle('visible');
            chevron.classList.toggle('expanded');
        });

        // Update human player dropdown when player names change
        document.getElementById('players-container').addEventListener('input', (e) => {
            if (e.target.type === 'text') {
                updateHumanPlayerOptions();
            }
        });

        // Form submission
        document.getElementById('setup-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const players = [];
            const total = getTotalPlayers();

            for (let i = 1; i <= total; i++) {
                const name = formData.get(`player${i}_name`);
                const model = formData.get(`player${i}_model`);
                if (name && model) {
                    players.push({ name, model });
                }
            }

            if (players.length < 3) {
                showError('Need at least 3 players');
                return;
            }

            const roleDistribution = getRoleDistribution();

            // Get human player settings if enabled
            const enableHuman = document.getElementById('enable-human').checked;
            let humanPlayerName = null;
            let forcedRole = null;

            if (enableHuman) {
                humanPlayerName = document.getElementById('human-player-select').value;
                forcedRole = document.getElementById('human-role-select').value || null;

                // Validate human player selection
                if (!humanPlayerName) {
                    showError('Please select which player you want to be');
                    return;
                }
                console.log('Human player settings:', { humanPlayerName, forcedRole });
            }

            try {
                const response = await fetch('/start_game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        players,
                        role_distribution: roleDistribution,
                        human_player_name: humanPlayerName,
                        forced_role: forcedRole,
                        game_rules: getGameRules()
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    window.location.href = data.redirect;
                } else {
                    showError(data.error || 'Failed to start game');
                }
            } catch (error) {
                showError('Error starting game: ' + error.message);
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Initialize
        initializeBulkModelSelect();
        applyPreset('standard');
    </script>
</body>
</html>
