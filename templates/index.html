<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia AI - Setup</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Mafia AI Game Setup</h1>
        <p>Configure your AI players and start the game.</p>
        
        <form id="setup-form">
            <div id="players-container">
                <!-- Players will be added here -->
            </div>
            
            <button type="button" id="add-player-btn">Add Player</button>
            <button type="button" id="remove-player-btn">Remove Player</button>
            <button type="submit" id="start-game-btn">Start Game</button>
        </form>
        
        <div id="error-message" class="error" style="display: none;"></div>
    </div>
    
    <script>
        const defaultModels = {{ default_models | tojson }};
        const modelPricing = {{ model_pricing | tojson }};
        // Friendly default names to use instead of "Player 1", "Player 2", ...
        const defaultNames = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Heidi', 'Ivan', 'Judy'];
        let playerCount = 7; // Default
        
        // Initialize with default players
        function initializePlayers() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            
            for (let i = 0; i < playerCount; i++) {
                addPlayerRow(i + 1);
            }
        }
        
        function formatPricing(modelId) {
            if (modelPricing[modelId]) {
                const p = modelPricing[modelId];
                return ` ($${p.input.toFixed(2)}/$1M in, $${p.output.toFixed(2)}/$1M out)`;
            }
            return '';
        }
        
        function addPlayerRow(num) {
            const container = document.getElementById('players-container');
            const div = document.createElement('div');
            div.className = 'player-row';

            // Pick a friendly default name when available
            const defaultName = defaultNames[num - 1] || `Player ${num}`;

            // Randomly select a default model
            const randomModel = defaultModels[Math.floor(Math.random() * defaultModels.length)];

            div.innerHTML = `
                <label>Player ${num}:</label>
                <input type="text" name="player${num}_name" placeholder="${defaultName}" value="${defaultName}" required>
                <select name="player${num}_model" required>
                    ${defaultModels.map(model => {
                        const pricing = formatPricing(model);
                        const selected = model === randomModel ? ' selected' : '';
                        return `<option value="${model}"${selected}>${model}${pricing}</option>`;
                    }).join('')}
                </select>
            `;
            container.appendChild(div);
        }
        
        document.getElementById('add-player-btn').addEventListener('click', () => {
            playerCount++;
            addPlayerRow(playerCount);
        });
        
        document.getElementById('remove-player-btn').addEventListener('click', () => {
            if (playerCount > 3) {
                const container = document.getElementById('players-container');
                container.removeChild(container.lastChild);
                playerCount--;
            } else {
                alert('Need at least 3 players');
            }
        });
        
        document.getElementById('setup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const players = [];
            
            for (let i = 1; i <= playerCount; i++) {
                const name = formData.get(`player${i}_name`);
                const model = formData.get(`player${i}_model`);
                if (name && model) {
                    players.push({ name, model });
                }
            }
            
            if (players.length < 3) {
                showError('Need at least 3 players');
                return;
            }
            
            try {
                const response = await fetch('/start_game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ players })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    window.location.href = data.redirect;
                } else {
                    showError(data.error || 'Failed to start game');
                }
            } catch (error) {
                showError('Error starting game: ' + error.message);
            }
        });
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Initialize on load
        initializePlayers();
    </script>
</body>
</html>

